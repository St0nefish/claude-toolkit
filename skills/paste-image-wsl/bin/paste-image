#!/usr/bin/env bash
set -euo pipefail

PWSH="/mnt/c/WINDOWS/System32/WindowsPowerShell/v1.0/powershell.exe"
CHECK_FILE="/tmp/.wsl_clipboard_check.png"

cleanup() { rm -f "$CHECK_FILE"; }
trap cleanup EXIT

# Check if Windows clipboard has an image
has_image=$("$PWSH" -NoProfile -Command "
    Add-Type -AssemblyName System.Windows.Forms
    if ([System.Windows.Forms.Clipboard]::ContainsImage()) { Write-Output 'true' }
    else { Write-Output 'false' }
" 2>/dev/null | tr -d '\r')

if [[ "$has_image" != "true" ]]; then
    echo "No image in clipboard" >&2
    exit 1
fi

# Save clipboard image to temp file
"$PWSH" -NoProfile -Command "
    Add-Type -AssemblyName System.Windows.Forms
    Add-Type -AssemblyName System.Drawing
    \$image = [System.Windows.Forms.Clipboard]::GetImage()
    if (\$image) {
        \$image.Save('$(wslpath -w "$CHECK_FILE")', [System.Drawing.Imaging.ImageFormat]::Png)
    }
" 2>/dev/null

if [[ ! -f "$CHECK_FILE" ]]; then
    echo "Failed to save clipboard image" >&2
    exit 1
fi

# Deduplicate by content hash
current_hash=$(md5sum "$CHECK_FILE" | cut -d' ' -f1)
final_file="/tmp/wsl_clip_${current_hash}.png"

if [[ ! -f "$final_file" ]]; then
    mv "$CHECK_FILE" "$final_file"
else
    rm "$CHECK_FILE"
fi

# Disarm the EXIT trap since we handled CHECK_FILE ourselves
trap - EXIT

echo "$final_file"
