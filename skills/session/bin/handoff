#!/usr/bin/env bash
# handoff - Create a WIP commit with structured handoff context and push
# Exit codes: 0 success, 1 bad usage, 2 not a git repo, 3 nothing to commit, 4 push failed

set -euo pipefail

usage() {
    cat <<'EOF'
Usage: handoff -m MESSAGE

Creates a WIP commit with structured handoff context and pushes it
for cross-machine transfer.

The MESSAGE should contain structured sections separated by
=== SECTION === headers:

  === IN PROGRESS ===
  <current state of work>

  === NEXT STEPS ===
  <what to pick up next>

  === KEY CONTEXT ===
  <decisions, gotchas, important state>

Options:
  -m MESSAGE    Handoff message (required)
  -h, --help    Show this help
EOF
    exit 1
}

message=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help) usage ;;
        -m)
            [[ $# -lt 2 ]] && { echo "Error: -m requires a message" >&2; exit 1; }
            message="$2"
            shift 2
            ;;
        *)
            echo "Error: unexpected argument '$1'" >&2
            usage
            ;;
    esac
done

if [[ -z "$message" ]]; then
    echo "Error: -m MESSAGE is required" >&2
    usage
fi

# Check we're in a git repo
if ! git rev-parse --git-dir &>/dev/null; then
    echo "Error: not a git repository" >&2
    exit 2
fi

# Stage everything
git add -A

# Check there's something to commit
if git diff --cached --quiet; then
    echo "Error: nothing to commit (working tree clean)" >&2
    exit 3
fi

# Build commit message
branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
hostname=$(hostname -s 2>/dev/null || echo "unknown")

# Extract first line for subject, truncate to 72 chars
first_line=$(echo "$message" | head -1)
if [[ ${#first_line} -gt 72 ]]; then
    first_line="${first_line:0:69}..."
fi

# List staged files
staged_files=$(git diff --cached --name-only)

commit_body="WIP: ${first_line}

=== HANDOFF ===
Branch: ${branch}
Timestamp: ${timestamp}
From: ${hostname}

${message}

=== FILES IN THIS COMMIT ===
${staged_files}"

# Commit
git commit -m "$commit_body" --no-verify

echo "Committed WIP handoff on branch '$branch'"

# Push
if git push 2>&1; then
    echo "Pushed to remote. Resume on another machine with:"
    echo "  git pull && /session:resume"
else
    echo "Warning: push failed â€” commit exists locally." >&2
    echo "Push manually with: git push" >&2
    exit 4
fi
