#!/usr/bin/env bash
set -euo pipefail

# screenshot â€” Find and return the most recent screenshot.
# Platform-aware: macOS, WSL, and Linux.
# Looks in SCREENSHOTS_DIR (default depends on platform).

detect_platform() {
    case "$(uname -s)" in
        Darwin) echo "macos" ;;
        Linux)
            if [[ -f /proc/version ]] && grep -qi microsoft /proc/version; then
                echo "wsl"
            else
                echo "linux"
            fi
            ;;
        *) echo "unknown" ;;
    esac
}

PLATFORM="$(detect_platform)"

# Determine default screenshots directory
if [[ -z "${SCREENSHOTS_DIR:-}" ]]; then
    case "$PLATFORM" in
        macos|linux)
            SCREENSHOTS_DIR="$HOME/Pictures/Screenshots"
            ;;
        wsl)
            WIN_USER=$(cmd.exe /C "echo %USERNAME%" 2>/dev/null | tr -d '\r')
            SCREENSHOTS_DIR="/mnt/c/Users/${WIN_USER}/Pictures/Screenshots"
            ;;
        *)
            echo "Unsupported platform" >&2
            exit 1
            ;;
    esac
fi

if [[ ! -d "$SCREENSHOTS_DIR" ]]; then
    echo "Screenshots directory not found: $SCREENSHOTS_DIR" >&2
    echo "Set SCREENSHOTS_DIR to override." >&2
    exit 1
fi

# Find the newest .png file
newest=""
newest_ts=0

while IFS= read -r -d '' file; do
    case "$PLATFORM" in
        macos) ts=$(stat -f '%m' "$file" 2>/dev/null) || continue ;;
        *)     ts=$(stat -c '%Y' "$file" 2>/dev/null) || continue ;;
    esac
    if (( ts > newest_ts )); then
        newest_ts=$ts
        newest="$file"
    fi
done < <(find "$SCREENSHOTS_DIR" -maxdepth 1 -type f -name '*.png' -print0 2>/dev/null)

if [[ -z "$newest" ]]; then
    echo "No screenshots found in $SCREENSHOTS_DIR" >&2
    exit 1
fi

echo "$newest"
