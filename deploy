#!/usr/bin/env bash
# deploy â€” convenience wrapper
# Builds and runs the Rust deploy tool from deploy-rs/.
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if ! command -v cargo &>/dev/null; then
  echo "Error: cargo not found. Install Rust via: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh" >&2
  exit 1
fi

CARGO_DIR="$SCRIPT_DIR/deploy-rs"
BINARY="$CARGO_DIR/target/release/deploy"

# Build release binary if missing or stale
if [[ ! -x "$BINARY" ]] || [[ "$(find "$CARGO_DIR/src" -newer "$BINARY" 2>/dev/null)" ]]; then
  cargo build --release --manifest-path "$CARGO_DIR/Cargo.toml" --quiet
fi

exec "$BINARY" "$@"
