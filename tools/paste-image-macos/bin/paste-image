#!/usr/bin/env bash
set -euo pipefail

# paste-image — Paste an image from the macOS clipboard to a temp file.
# Requires pngpaste (brew install pngpaste).

if ! command -v pngpaste >/dev/null 2>&1; then
    echo "pngpaste not found — install with: brew install pngpaste" >&2
    exit 1
fi

CHECK_FILE="/tmp/.mac_clipboard_check.png"

cleanup() { rm -f "$CHECK_FILE"; }
trap cleanup EXIT

# pngpaste exits non-zero if clipboard has no image
if ! pngpaste "$CHECK_FILE" 2>/dev/null; then
    echo "No image in clipboard" >&2
    exit 1
fi

if [[ ! -f "$CHECK_FILE" ]]; then
    echo "Failed to save clipboard image" >&2
    exit 1
fi

# Deduplicate by content hash
current_hash=$(md5 -q "$CHECK_FILE")
final_file="/tmp/mac_clip_${current_hash}.png"

if [[ ! -f "$final_file" ]]; then
    mv "$CHECK_FILE" "$final_file"
else
    rm "$CHECK_FILE"
fi

# Disarm the EXIT trap since we handled CHECK_FILE ourselves
trap - EXIT

echo "$final_file"
